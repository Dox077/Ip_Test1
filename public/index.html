<!-- <!DOCTYPE html>
<html>
<head>
  <title>Save Username to Google Sheet</title>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h1>Save Username to Google Sheet</h1>
  <form>
    <label for="username">Enter your username:</label>
    <input type="text" id="username" name="username">
    <button type="button" onclick="saveUsername()">Save</button>
  </form>
  <script>
  function initClient() {
  gapi.client.init({
    apiKey: 'AIzaSyA-hcANdJmipBAeDxGO7A7I2Xao5xex0XE',
    clientId: '1023049278699-489s2oqrr75au1a0e214hjvtqr99kfbk.apps.googleusercontent.com',
    scope: 'https://www.googleapis.com/auth/spreadsheets',
  }).then(() => {
    console.log('Google Sheets API initialized.');

    // After initializing the API successfully, it proceeds to authenticate the user.
    gapi.auth2.getAuthInstance().signIn().then(() => {
      console.log('User authenticated.');
    }, (error) => {
      console.error('Error authenticating user:', error);
    });
  }, (error) => {
    console.error('Error initializing Google Sheets API:', error);
  });
}


    async function saveUsername() {
      const username = document.getElementById('username').value;
      const spreadsheetId = '1UDDarsUSFfdEhALQUlPvONklLpR0jzeV5kTaJ6Nslr4'; // Replace with your Google Sheet ID
      const range = 'Sheet1!G32'; // Replace with the desired cell
      const valueInputOption = 'USER_ENTERED';
      const resource = {
        values: [[username]],
      };
      const accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
      const headers = new Headers();
      headers.append('Authorization', `Bearer ${accessToken}`);
      const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?valueInputOption=${valueInputOption}`, {
        method: 'PUT',
        headers,
        body: JSON.stringify(resource),
      });
      const data = await response.json();
      console.log(`${data.updatedCells} cells updated.`);
    }

    gapi.load('client', initClient);
  </script>
</body>
</html> -->






<!DOCTYPE html>
<html>
<head>
    <title>IP Tracker</title>
</head>
<body>
    <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
    <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>
    <h1>IP Tracker</h1>
    <button onclick="saveIPAddress()">Save IP Address</button>

    <script type="text/javascript">
        // Replace with your API key
        const API_KEY = 'AIzaSyA-hcANdJmipBAeDxGO7A7I2Xao5xex0XE';

        // Client ID and API key from the Developer Console
        const CLIENT_ID = '1023049278699-489s2oqrr75au1a0e214hjvtqr99kfbk.apps.googleusercontent.com';

        // Array of API discovery doc URLs for APIs used by the application
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';

        // Authorization scopes required by the API
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';
        // const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        // Google Sheets spreadsheet ID and range
        const SPREADSHEET_ID = '1UDDarsUSFfdEhALQUlPvONklLpR0jzeV5kTaJ6Nslr4';
        const RANGE = 'Sheet1';

        let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      document.getElementById('authorize_button').style.visibility = 'hidden';
      document.getElementById('signout_button').style.visibility = 'hidden';

        // function handleClientLoad() {
        //     gapi.load('client:auth2', initClient);
        // }

        function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
      }

      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        maybeEnableButtons();
      }

      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '', // defined later
        });
        gisInited = true;
        maybeEnableButtons();
      }

      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById('authorize_button').style.visibility = 'visible';
        }
      }

        // function initClient() {
        //     gapi.client.init({
        //         apiKey: API_KEY,
        //         clientId: CLIENT_ID,
        //         discoveryDocs: DISCOVERY_DOCS,
        //         scope: SCOPES
        //     }).then(function() {
        //         // Listen for sign-in state changes.
        //         gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        //         // Handle the initial sign-in state.
        //         updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        //     });
        // }

        // function updateSigninStatus(isSignedIn) {
        //     if (isSignedIn) {
        //         console.log("User is signed in.");
        //     } else {
        //         console.log("User is not signed in.");
        //     }
        // }

        function handleAuthClick() {
            // gapi.auth2.getAuthInstance().signIn();
            tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw (resp);
          }
          document.getElementById('signout_button').style.visibility = 'visible';
          document.getElementById('authorize_button').innerText = 'Refresh';
          await getIPAddress();
        };

        if (gapi.client.getToken() === null) {
          // Prompt the user to select a Google Account and ask for consent to share their data
          // when establishing a new session.
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          // Skip display of account chooser and consent dialog for an existing session.
          tokenClient.requestAccessToken({prompt: ''});
        }
        }

        function handleSignoutClick() {
            // gapi.auth2.getAuthInstance().signOut();
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('content').innerText = '';
                document.getElementById('authorize_button').innerText = 'Authorize';
                document.getElementById('signout_button').style.visibility = 'hidden';
            }
        }

        async function getIPAddress() {
            const response = await fetch('https://api64.ipify.org?format=json');
            const data = await response.json();
            console.log("getting ip", data);
            return data.ip;
        }

        // async function saveIPAddress() {
        //     const ipAddress = await getIPAddress();
        //     gapi.client.sheets.spreadsheets.values.append({
        //         spreadsheetId: SPREADSHEET_ID,
        //         range: RANGE,
        //         valueInputOption: 'RAW',
        //         insertDataOption: 'INSERT_ROWS',
        //         resource: {
        //             values: [[ipAddress]]
        //         }
        //     }).then((response) => {
        //         console.log(`${response.result.updates.updatedCells} cells appended.`);
        //     }, (error) => {
        //         console.error('Error appending data: ', error);
        //     });
        // }

        async function saveIPAddress() {
    const accessToken = gapi.client.getToken(); // Replace with the actual access token

    const ipAddress = await getIPAddress();

    const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}:append`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            values: [[ipAddress]],
        }),
    });

    const data = await response.json();
    console.log(data);
}
    </script>
    <!-- <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script> -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>